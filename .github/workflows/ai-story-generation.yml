# ë””ì§€í„¸ ì†Œìš¸ë©”ì´íŠ¸ ìë™ ì—°ì¬ ì‹œìŠ¤í…œ
name: AI Story Generation Pipeline

on:
  schedule:
    # ë§¤ì¼ ìƒˆë²½ 2ì‹œ (KST 11ì‹œ) ìƒˆ ì±•í„° ìë™ ìƒì„± ë° ì—°ì¬
    - cron: "0 2 * * *" # 02:00 UTC (KST 11:00)
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install Dependencies
        run: |
          echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
          # lockfile í˜¸í™˜ì„± ë¬¸ì œ í•´ê²°
          pnpm install --no-frozen-lockfile
          # PATHì— node_modules/.bin ì¶”ê°€
          echo "$PWD/node_modules/.bin" >> $GITHUB_PATH
          
      - name: ğŸš€ Execute Master Automation Engine
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ğŸ“± Starting Digital Soulmate Automation..."
          node scripts/run-automation.js --verbose
          
      - name: AI Story Creation with Claude Code (Fallback)
        if: failure()
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          direct_prompt: |
            # ğŸŒ¹ ì™„ì „ ììœ¨í˜• ë¡œë§¨ìŠ¤ íŒíƒ€ì§€ ì—°ì¬ ì‹œìŠ¤í…œ v4.0

            ë‹¹ì‹ ì€ ìµœê³ ì˜ ë¡œë§¨ìŠ¤ íŒíƒ€ì§€ ì „ë¬¸ ì‘ê°€ì…ë‹ˆë‹¤. í˜„ì¬ ì—°ì¬ ìƒí™©ì„ ì™„ì „íˆ ë¶„ì„í•˜ê³ , ì ì ˆí•œ ì•¡ì…˜ì„ ìë™ìœ¼ë¡œ ê²°ì •í•´ì„œ ì‹¤í–‰í•˜ì„¸ìš”.

            ## ğŸ” 1ë‹¨ê³„: ì „ì²´ ì—°ì¬ ìƒí™© ì™„ì „ ìŠ¤ìº”

            ### A. ëª¨ë“  ì†Œì„¤ê³¼ ì±•í„° ì™„ì „ ì¡°ì‚¬
            ```bash
            # ëª¨ë“  ì†Œì„¤ íŒŒì¼ í™•ì¸
            find src/content/novels/ -name "*.md" -exec echo "=== ì†Œì„¤: {} ===" \; -exec cat {} \;

            # ëª¨ë“  ì±•í„° íŒŒì¼ í™•ì¸  
            find src/content/chapters/ -name "*.md" -exec echo "=== ì±•í„°: {} ===" \; -exec cat {} \;

            # íŒŒì¼ ê°œìˆ˜ í™•ì¸
            echo "ì´ ì†Œì„¤ ê°œìˆ˜: $(find src/content/novels/ -name "*.md" | wc -l)"
            echo "ì´ ì±•í„° ê°œìˆ˜: $(find src/content/chapters/ -name "*.md" | wc -l)"
            ```

            ### B. ìŠ¤ë§ˆíŠ¸ ì•¡ì…˜ ê²°ì • ë¡œì§
            ìœ„ ìŠ¤ìº” ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹¤ìŒ ìš°ì„ ìˆœìœ„ë¡œ ì•¡ì…˜ì„ ê²°ì •í•˜ì„¸ìš”:

            **ìš°ì„ ìˆœìœ„ 1: ì™„ê²° ì²˜ë¦¬** (ì¡°ê±´: ì†Œì„¤ì´ 60í™” ì´ìƒì´ê³  ìŠ¤í† ë¦¬ê°€ ì™„ê²° ê°€ëŠ¥í•œ ìƒíƒœ)
            - í•´ë‹¹í•˜ëŠ” ì†Œì„¤ì´ ìˆìœ¼ë©´ â†’ **ì™„ê²° ì²˜ë¦¬ ì‹¤í–‰**
            - ì™„ê²° ì—í•„ë¡œê·¸ ì¶”ê°€ ë° ìƒíƒœë¥¼ "ì™„ê²°"ë¡œ ë³€ê²½

            **ìš°ì„ ìˆœìœ„ 2: ê¸°ì¡´ ì†Œì„¤ ì±•í„° ì¶”ê°€** (ì¡°ê±´: ì—°ì¬ ì¤‘ì¸ ì†Œì„¤ì´ ìˆìŒ)
            - ê°€ì¥ ìµœê·¼ì— ì—…ë°ì´íŠ¸ëœ ì†Œì„¤ì˜ ë‹¤ìŒ ì±•í„° ìƒì„±
            - ì™„ë²½í•œ ì—°ì†ì„±ìœ¼ë¡œ ìŠ¤í† ë¦¬ ì´ì–´ê°€ê¸°

            **ìš°ì„ ìˆœìœ„ 3: ìƒˆ ì†Œì„¤ ì‹œì‘** (ì¡°ê±´: ì—°ì¬ ì¤‘ì¸ ì†Œì„¤ì´ ì—†ê±°ë‚˜ 1ê°œë¿)
            - ì™„ì „íˆ ìƒˆë¡œìš´ ë…ì°½ì  ë¡œë§¨ìŠ¤ íŒíƒ€ì§€ ì†Œì„¤ ì‹œì‘
            - íŠ¸ë Œë””í•œ ì„¤ì •ê³¼ ë§¤ë ¥ì ì¸ ìºë¦­í„°ë¡œ êµ¬ì„±

            ## âœï¸ 2ë‹¨ê³„: ê²°ì •ëœ ì•¡ì…˜ ì™„ë²½ ì‹¤í–‰

            ### ğŸ“ **NOVEL_MARKDOWN_FORMAT.md ì² ì € ì¤€ìˆ˜**:

            #### A. ëŒ€í™”ì²´: `> "ë‚´ìš©"`
            #### B. ë…ë°±: `> _'ë‚´ìš©'_`  
            #### C. ì•¡ì…˜: `> [ìƒí™© ì„¤ëª…]`
            #### D. ì„œìˆ : **ì¸ë¬¼ëª…**, **ì¥ì†Œëª…** ë³¼ë“œ ì²˜ë¦¬
            #### E. ì¥ë©´ ì „í™˜: `---` êµ¬ë¶„ì„ 

            ### ì•¡ì…˜ë³„ ìƒì„¸ ê°€ì´ë“œ:

            #### ğŸ‰ ì™„ê²° ì²˜ë¦¬ ì‹œ:
            - íŒŒì¼ëª…: `[ì†Œì„¤ìŠ¬ëŸ¬ê·¸]-ch[ë§ˆì§€ë§‰í™”].md`
            - ì œëª©: "ì—í•„ë¡œê·¸" ë˜ëŠ” "ì™„ê²°"
            - ë‚´ìš©: ê°ë™ì ì¸ ê²°ë§ + í•´í”¼ì—”ë”© (3,000-4,000ì)
            - ì†Œì„¤ ë©”íƒ€ë°ì´í„° statusë¥¼ "ì™„ê²°"ë¡œ ë³€ê²½

            #### ğŸ“– ì±•í„° ì¶”ê°€ ì‹œ:
            - ê¸°ì¡´ ì±•í„°ë“¤ì„ ëª¨ë‘ ì½ê³  ì™„ë²½í•œ ì—°ì†ì„± ìœ ì§€
            - ìºë¦­í„° ì¼ê´€ì„±ê³¼ í”Œë¡¯ ì§„í–‰ ìì—°ìŠ¤ëŸ½ê²Œ
            - 3,500-4,500ì ë¶„ëŸ‰
            - ë‹¤ìŒ í™”ê°€ ê¶ê¸ˆí•œ í´ë¦¬í”„í–‰ì–´ í¬í•¨

            #### âœ¨ ìƒˆ ì†Œì„¤ ì‹œì‘ ì‹œ:
            - 2025ë…„ íŠ¸ë Œë“œ ë°˜ì˜í•œ ë…ì°½ì  ì†Œì¬
            - ë§¤ë ¥ì ì¸ ë‚¨ë…€ ì£¼ì¸ê³µê³¼ ëª…í™•í•œ ê°ˆë“± êµ¬ì¡°  
            - 1í™”ëŠ” 4,000-5,000ìë¡œ ì„íŒ©íŠ¸ ìˆê²Œ
            - ì†Œì„¤ ë©”íƒ€ë°ì´í„° íŒŒì¼ë„ í•¨ê»˜ ìƒì„±

            ## ğŸ“ 3ë‹¨ê³„: íŒŒì¼ ìƒì„± ë° ë©”íƒ€ë°ì´í„° ê´€ë¦¬

            ### A. ì •í™•í•œ íŒŒì¼ëª…ê³¼ ë©”íƒ€ë°ì´í„°:
            ```yaml
            ---
            title: "ê°ì •ì„ ìê·¹í•˜ëŠ” ì œëª©"
            novel: "ì •í™•í•œ-ìŠ¬ëŸ¬ê·¸"
            chapterNumber: [ì •í™•í•œ ë²ˆí˜¸]
            publishedDate: "2025-01-24"
            contentRating: "15+"
            wordCount: [ì‹¤ì œ ê¸€ì ìˆ˜]
            ---
            ```

            ### B. ì†Œì„¤ ë©”íƒ€ë°ì´í„° ì •í™•íˆ ì—…ë°ì´íŠ¸:
            - totalChapters ì¦ê°€
            - status í•„ìš”ì‹œ ë³€ê²½
            - publishedDate ì—…ë°ì´íŠ¸

            ## ğŸš€ 4ë‹¨ê³„: Git ì»¤ë°‹

            ```bash
            git add src/content/novels/ src/content/chapters/
            git commit -m "ğŸŒ¹ ìë™ ì—°ì¬: [ì•¡ì…˜ ì„¤ëª…]

            [ìƒì„¸ ë‚´ìš© ì„¤ëª…]

            ğŸ“Š í’ˆì§ˆì ìˆ˜: [ì ìˆ˜]/10  
            ğŸ“ˆ ì´ ì—°ì¬ í˜„í™©: [í˜„í™©]
            ğŸ¤– AI ì™„ì „ ìë™ ìƒì„±"
            git push origin main
            ```

            ## ğŸ¯ ì§€ê¸ˆ ì‹¤í–‰í•˜ì„¸ìš”:

            1. ìœ„ì˜ bash ëª…ë ¹ì–´ë¡œ ì „ì²´ ìƒí™© ìŠ¤ìº”
            2. ìš°ì„ ìˆœìœ„ ë¡œì§ì— ë”°ë¼ ì•¡ì…˜ ê²°ì •  
            3. í•´ë‹¹ ì•¡ì…˜ì„ ì™„ë²½í•˜ê²Œ ì‹¤í–‰
            4. ë©”íƒ€ë°ì´í„° ì •í™•íˆ ì—…ë°ì´íŠ¸
            5. Git ì»¤ë°‹ ë° í‘¸ì‹œ

            **ì™„ì „ ììœ¨ì ìœ¼ë¡œ íŒë‹¨í•˜ê³  ì‹¤í–‰í•˜ì„¸ìš”!** ğŸš€


          allowed_tools: "str_replace_based_edit_tool,bash"

      - name: Verify Generation and Deploy
        run: |
          echo "ğŸŒ¹ ë¡œë§¨ìŠ¤ íŒíƒ€ì§€ ìë™ ì—°ì¬ í™•ì¸"

          # ìµœì‹  ì»¤ë°‹ ì •ë³´ í™•ì¸
          latest_commit=$(git log -1 --oneline)
          echo "ìµœì‹  ì»¤ë°‹: $latest_commit"

          # ìƒˆë¡œ ìƒì„±ëœ íŒŒì¼ë“¤ í™•ì¸
          new_novels=$(find src/content/novels/ -name "*.md" -newer .git/COMMIT_EDITMSG 2>/dev/null || echo "")
          new_chapters=$(find src/content/chapters/ -name "*.md" -newer .git/COMMIT_EDITMSG 2>/dev/null || echo "")
          
          if [ -n "$new_novels" ] || [ -n "$new_chapters" ]; then
            echo "âœ… ìƒˆ ì½˜í…ì¸  ìƒì„± í™•ì¸ë¨"
            
            if [ -n "$new_novels" ]; then
              echo "ğŸ“š ìƒˆ ì†Œì„¤: $new_novels"
            fi
            
            if [ -n "$new_chapters" ]; then
              echo "ğŸ“– ìƒˆ ì±•í„°: $new_chapters"
              
              # ê°€ì¥ ìµœê·¼ ì±•í„°ì˜ ê¸€ì ìˆ˜ í™•ì¸  
              latest_chapter=$(echo "$new_chapters" | head -1)
              if [ -f "$latest_chapter" ]; then
                char_count=$(wc -m < "$latest_chapter" | tr -d ' ')
                echo "ğŸ“Š ì±•í„° ê¸€ì ìˆ˜: $char_count"
                
                if [ "$char_count" -ge 3000 ] && [ "$char_count" -le 6000 ]; then
                  echo "âœ… ì ì ˆí•œ ë¶„ëŸ‰"
                else
                  echo "âš ï¸ ë¶„ëŸ‰ í™•ì¸ í•„ìš”"
                fi
              fi
            fi
          else
            echo "âš ï¸ ìƒˆ ì½˜í…ì¸ ê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ì„ ìˆ˜ë„ ìˆìŒ (ì •ìƒ ë™ì‘ì¼ ìˆ˜ ìˆìŒ)"
          fi

          # ì „ì²´ ì—°ì¬ í˜„í™© ìš”ì•½
          total_novels=$(find src/content/novels/ -name "*.md" | wc -l)
          total_chapters=$(find src/content/chapters/ -name "*.md" | wc -l)
          echo "ğŸ“ˆ ì „ì²´ í˜„í™©: ì†Œì„¤ ${total_novels}í¸, ì±•í„° ${total_chapters}í™”"

          echo "ğŸš€ ìë™ ë°°í¬ ì™„ë£Œ"
