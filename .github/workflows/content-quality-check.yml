# ì½˜í…ì¸  í’ˆì§ˆ ìë™ ê²€ì‚¬ (Push ì´ë²¤íŠ¸ ëŒ€ì‘)
name: Content Quality Auto-Check

on:
  push:
    paths: 
      - "src/content/chapters/**/*.md"
      - "src/content/novels/**/*.md"
    branches:
      - main
      - master

jobs:
  auto-quality-check:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check Content Files
        id: check_files
        run: |
          echo "ğŸ” ì½˜í…ì¸  íŒŒì¼ ë³€ê²½ì‚¬í•­ í™•ì¸ ì¤‘..."
          
          # ë³€ê²½ëœ íŒŒì¼ í™•ì¸
          changed_files=$(git diff --name-only HEAD~1 HEAD | grep -E "(src/content/chapters/.*\.md|src/content/novels/.*\.md)" || echo "")
          
          if [[ -n "$changed_files" ]]; then
            echo "ğŸ“ ë³€ê²½ëœ ì½˜í…ì¸  íŒŒì¼:"
            echo "$changed_files"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "changed_files<<EOF" >> $GITHUB_OUTPUT
            echo "$changed_files" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ ì½˜í…ì¸  íŒŒì¼ ë³€ê²½ì‚¬í•­ ì—†ìŒ"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Basic Quality Validation
        id: basic_quality
        if: steps.check_files.outputs.has_changes == 'true'
        run: |
          echo "ğŸ” ê¸°ë³¸ í’ˆì§ˆ ê²€ì¦ ì‹œì‘..."
          
          # ë³€ê²½ëœ íŒŒì¼ë“¤ì— ëŒ€í•´ í’ˆì§ˆ ê²€ì‚¬
          IFS=$'\n' read -rd '' -a files_array <<< "${{ steps.check_files.outputs.changed_files }}"
          
          failed_files=()
          passed_files=()
          
          for file in "${files_array[@]}"; do
            if [[ -f "$file" ]]; then
              echo "ğŸ“– ê²€ì‚¬ ì¤‘: $file"
              
              # 1. ë©”íƒ€ë°ì´í„° í™•ì¸
              if ! head -10 "$file" | grep -q "^title:"; then
                echo "âŒ $file: ì œëª© ë©”íƒ€ë°ì´í„° ëˆ„ë½"
                failed_files+=("$file:ë©”íƒ€ë°ì´í„°ëˆ„ë½")
                continue
              fi
              
              # 2. ê¸€ì ìˆ˜ í™•ì¸
              char_count=$(wc -m < "$file" | tr -d ' ')
              if [[ $char_count -lt 2000 ]]; then
                echo "âŒ $file: ê¸€ì ìˆ˜ ë¶€ì¡± ($char_count < 2000)"
                failed_files+=("$file:ê¸€ììˆ˜ë¶€ì¡±($char_count)")
                continue
              fi
              
              # 3. ë§ˆí¬ë‹¤ìš´ í˜•ì‹ í™•ì¸
              dialogue_count=$(grep -c '^> "' "$file" 2>/dev/null || echo 0)
              if [[ $dialogue_count -eq 0 ]]; then
                echo "âš ï¸ $file: ëŒ€í™”ì²´ ì—†ìŒ (í™•ì¸ í•„ìš”)"
              fi
              
              # 4. í•œê¸€ ì½˜í…ì¸  í™•ì¸
              korean_chars=$(grep -o '[ê°€-í£]' "$file" 2>/dev/null | wc -l | tr -d ' ')
              if [[ $korean_chars -lt 500 ]]; then
                echo "âŒ $file: í•œê¸€ ì½˜í…ì¸  ë¶€ì¡± ($korean_chars < 500)"
                failed_files+=("$file:í•œê¸€ë¶€ì¡±($korean_chars)")
                continue
              fi
              
              echo "âœ… $file: ê¸°ë³¸ í’ˆì§ˆ ê¸°ì¤€ í†µê³¼ (${char_count}ì, í•œê¸€ ${korean_chars}ì, ëŒ€í™” ${dialogue_count}ê°œ)"
              passed_files+=("$file")
            else
              echo "âš ï¸ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ: $file"
            fi
          done
          
          # ê²°ê³¼ ìš”ì•½
          echo ""
          echo "ğŸ“Š í’ˆì§ˆ ê²€ì¦ ê²°ê³¼:"
          echo "âœ… í†µê³¼: ${#passed_files[@]}ê°œ íŒŒì¼"
          echo "âŒ ì‹¤íŒ¨: ${#failed_files[@]}ê°œ íŒŒì¼"
          
          if [[ ${#failed_files[@]} -gt 0 ]]; then
            echo ""
            echo "ì‹¤íŒ¨í•œ íŒŒì¼ë“¤:"
            for failed in "${failed_files[@]}"; do
              echo "  - $failed"
            done
            
            # GitHub Issue ìƒì„±ì„ ìœ„í•œ ì •ë³´ ì €ì¥
            echo "quality_failed=true" >> $GITHUB_OUTPUT
            echo "failed_files<<EOF" >> $GITHUB_OUTPUT
            printf '%s\n' "${failed_files[@]}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "quality_failed=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Quality Issue
        if: steps.check_files.outputs.has_changes == 'true' && steps.basic_quality.outputs.quality_failed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const failedFiles = `${{ steps.basic_quality.outputs.failed_files }}`.split('\n').filter(f => f.trim());
            
            const issueBody = `
            ## ğŸ“Š ì½˜í…ì¸  í’ˆì§ˆ ê²€ì¦ ì‹¤íŒ¨
            
            **ì»¤ë°‹**: ${{ github.sha }}
            **ë¸Œëœì¹˜**: ${{ github.ref_name }}
            **ì‹œê°„**: ${new Date().toLocaleString('ko-KR', {timeZone: 'Asia/Seoul'})}
            
            ### âŒ ì‹¤íŒ¨í•œ íŒŒì¼ë“¤
            
            ${failedFiles.map(f => `- \`${f}\``).join('\n')}
            
            ### ğŸ”§ ê°œì„  í•„ìš”ì‚¬í•­
            
            1. **ë©”íƒ€ë°ì´í„°**: ëª¨ë“  íŒŒì¼ì— \`title:\`, \`novel:\`, \`chapterNumber:\` í•„ìˆ˜
            2. **ìµœì†Œ ë¶„ëŸ‰**: ì±•í„°ë‹¹ ìµœì†Œ 2,000ì ì´ìƒ
            3. **í•œê¸€ ì½˜í…ì¸ **: ìµœì†Œ 500ì ì´ìƒì˜ í•œê¸€ ì½˜í…ì¸ 
            4. **ë§ˆí¬ë‹¤ìš´ í˜•ì‹**: 
               - ëŒ€í™”: \`> "ë‚´ìš©"\`
               - ë…ë°±: \`> _'ë‚´ìš©'_\`
               - ì•¡ì…˜: \`> [í–‰ë™]\`
            
            ### ğŸ“‹ ì²´í¬ë¦¬ìŠ¤íŠ¸
            
            - [ ] ë©”íƒ€ë°ì´í„° ë³´ì™„
            - [ ] ì½˜í…ì¸  ë¶„ëŸ‰ í™•ë³´
            - [ ] ë§ˆí¬ë‹¤ìš´ í˜•ì‹ ì ìš©
            - [ ] í’ˆì§ˆ ì¬ê²€ì¦
            
            **ìë™ ìƒì„±ëœ ì´ìŠˆì…ë‹ˆë‹¤. ë¬¸ì œ í•´ê²° í›„ ì´ ì´ìŠˆë¥¼ ë‹«ì•„ì£¼ì„¸ìš”.**
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[í’ˆì§ˆê²€ì¦] ì½˜í…ì¸  í’ˆì§ˆ ê¸°ì¤€ ë¯¸ë‹¬ (${failedFiles.length}ê°œ íŒŒì¼)`,
              body: issueBody,
              labels: ['quality-check', 'content', 'automated']
            });

      - name: Quality Check Summary
        if: steps.check_files.outputs.has_changes == 'true'
        run: |
          echo "ğŸ“Š ì½˜í…ì¸  í’ˆì§ˆ ê²€ì‚¬ ì™„ë£Œ"
          echo "========================"
          echo "ğŸ” ê²€ì‚¬ ëŒ€ìƒ: ${{ steps.check_files.outputs.has_changes == 'true' && 'ìˆìŒ' || 'ì—†ìŒ' }}"
          
          if [[ "${{ steps.basic_quality.outputs.quality_failed }}" == "true" ]]; then
            echo "âŒ í’ˆì§ˆ ê²€ì¦: ì‹¤íŒ¨ (ê°œì„  í•„ìš”)"
            echo "ğŸ“‹ GitHub ì´ìŠˆê°€ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
            exit 1
          else
            echo "âœ… í’ˆì§ˆ ê²€ì¦: í†µê³¼"
          fi

      - name: Success Notification
        if: steps.check_files.outputs.has_changes == 'true' && steps.basic_quality.outputs.quality_failed != 'true'
        run: |
          echo "ğŸ‰ ëª¨ë“  ì½˜í…ì¸  íŒŒì¼ì´ í’ˆì§ˆ ê¸°ì¤€ì„ ì¶©ì¡±í•©ë‹ˆë‹¤!"
          echo "âœ… ìë™ ë°°í¬ ì¤€ë¹„ ì™„ë£Œ"