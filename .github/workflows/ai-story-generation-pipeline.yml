name: AI Story Generation Pipeline

on:
  schedule:
    # Gemini API íŠ¸ë˜í”½ ë¶„ì‚°: ì‹œê°„ëŒ€ë³„ ë°±ì—… ì‹¤í–‰
    - cron: '0 1 * * *' # 01:00 UTC (KST 10:00) - ë©”ì¸ ì‹œê°„
    - cron: '30 2 * * *' # 02:30 UTC (KST 11:30) - ë°±ì—… ì‹¤í–‰
    - cron: '0 4 * * *' # 04:00 UTC (KST 13:00) - ìµœì¢… ë°±ì—…

  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©
    inputs:
      force_mode:
        description: 'ê°•ì œ ì‹¤í–‰ ëª¨ë“œ (ì—ëŸ¬ ë¬´ì‹œ)'
        required: false
        default: false
        type: boolean

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: ì²´í¬ì•„ì›ƒ ì½”ë“œ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: pnpm í™˜ê²½ ì„¤ì •
        uses: pnpm/action-setup@v4
        with:
          version: 8
          run_install: false

      - name: Node.js í™˜ê²½ ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          echo "pnpmìœ¼ë¡œ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
          pnpm install --no-frozen-lockfile
          echo "ì„¤ì¹˜ ì™„ë£Œ"

      - name: API í‚¤ í™•ì¸
        run: |
          echo "API í‚¤ ìƒíƒœ í™•ì¸"
          if [ -n "${{ secrets.GEMINI_API_KEY }}" ]; then
            echo "GEMINI_API_KEY ì„¤ì •ë¨"
          else
            echo "GEMINI_API_KEY ì—†ìŒ"
            echo "GitHub Secretsì— GEMINI_API_KEYë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”"
            exit 1
          fi

      - name: ğŸ¯ ì—°ì†ì„± ì‹œìŠ¤í…œìœ¼ë¡œ Gemini AI ë¡œë§¨ìŠ¤ íŒíƒ€ì§€ ìë™ ìƒì„±
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ENABLE_CONTINUITY_SYSTEM: true
          NODE_ENV: production
        run: |
          echo "ğŸ¯ ì—°ì†ì„± ì‹œìŠ¤í…œ í†µí•© Gemini AI ë¡œë§¨ìŠ¤ íŒíƒ€ì§€ ìë™ ìƒì„± ì‹œì‘"
          echo "âœ¨ ì™„ë²½í•œ ë¬¸ë§¥ ìœ ì§€ | ê°œì—°ì„± ìˆëŠ” ìŠ¤í† ë¦¬ | ìë™ ì—”ë”© ê´€ë¦¬"

          # ì—°ì†ì„± ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸
          echo "ğŸ“Š ì—°ì†ì„± ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸..."
          if pnpm continuity:status; then
            echo "âœ… ì—°ì†ì„± ì‹œìŠ¤í…œ ì •ìƒ ì‘ë™"
          else
            echo "âš ï¸ ì—°ì†ì„± ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨, ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ ì§„í–‰"
          fi

          # ë°ì´í„° ë””ë ‰í† ë¦¬ í™•ì¸
          echo "ğŸ“ ìŠ¤í† ë¦¬ ìƒíƒœ ë””ë ‰í† ë¦¬ í™•ì¸..."
          mkdir -p data/story-states
          ls -la data/story-states/ || echo "ë°ì´í„° ë””ë ‰í† ë¦¬ ìƒì„±ë¨"

          # ìµœëŒ€ 3ë²ˆ ì¬ì‹œë„
          max_attempts=3
          attempt=1

          while [ $attempt -le $max_attempts ]; do
            echo "ğŸš€ ì‹œë„ $attempt/$max_attempts (ì—°ì†ì„± ëª¨ë“œ)"

            # ì—°ì†ì„± ì‹œìŠ¤í…œì„ ì‚¬ìš©í•œ ìë™í™” ì‹¤í–‰
            if node scripts/ai-novel-generator.js --mode auto --creativity high --verbose --continuity; then
              echo "âœ… ì—°ì†ì„± Gemini AI ìƒì„± ì„±ê³µ"
              
              # ìƒì„± í›„ ì—°ì†ì„± ìƒíƒœ í™•ì¸
              echo "ğŸ“Š ìƒì„± í›„ ì—°ì†ì„± ìƒíƒœ:"
              pnpm continuity:status || echo "ìƒíƒœ í™•ì¸ ì‹¤íŒ¨"
              
              break
            else
              echo "âŒ ì‹œë„ $attempt ì‹¤íŒ¨"
              if [ $attempt -lt $max_attempts ]; then
                echo "â³ 30ì´ˆ í›„ ì¬ì‹œë„..."
                sleep 30
              else
                echo "ğŸ’¥ ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼. ì—°ì†ì„± ì‹œìŠ¤í…œ ì‹¤íŒ¨"
                echo "ğŸ”„ ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ í´ë°± ì‹œë„..."
                
                # í´ë°±: ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ ì‹¤í–‰
                if ENABLE_CONTINUITY_SYSTEM=false node scripts/ai-novel-generator.js --mode auto --creativity high --verbose; then
                  echo "âœ… í´ë°± ìƒì„± ì„±ê³µ"
                else
                  echo "ğŸ’¥ í´ë°±ë„ ì‹¤íŒ¨. ì „ì²´ ì‹¤íŒ¨"
                  exit 1
                fi
              fi
            fi

            attempt=$((attempt + 1))
          done

          echo "ğŸŠ ì—°ì†ì„± Gemini AI ìƒì„± ì™„ë£Œ"


      - name: ğŸ¯ ì—°ì†ì„± ì‹œìŠ¤í…œ ìƒì„± ê²°ê³¼ í™•ì¸ ë° ë°°í¬
        if: always()
        run: |
          echo "ğŸ¯ ì—°ì†ì„± ë¡œë§¨ìŠ¤ íŒíƒ€ì§€ ìë™ ì—°ì¬ í™•ì¸"

          # ì—°ì†ì„± ì‹œìŠ¤í…œ ìµœì¢… ìƒíƒœ í™•ì¸
          echo "ğŸ“Š ì—°ì†ì„± ì‹œìŠ¤í…œ ìµœì¢… ìƒíƒœ:"
          if pnpm continuity:status; then
            echo "âœ… ì—°ì†ì„± ì‹œìŠ¤í…œ ì •ìƒ ì¢…ë£Œ"
          else
            echo "âš ï¸ ì—°ì†ì„± ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸ ë¶ˆê°€"
          fi

          # ìŠ¤í† ë¦¬ ìƒíƒœ íŒŒì¼ë“¤ í™•ì¸
          echo "ğŸ“ ìŠ¤í† ë¦¬ ìƒíƒœ íŒŒì¼ í™•ì¸:"
          if [ -d "data/story-states" ]; then
            story_count=$(find data/story-states/ -name "*.json" | wc -l)
            echo "í™œì„± ìŠ¤í† ë¦¬: ${story_count}ê°œ"
            if [ $story_count -gt 0 ]; then
              echo "ìŠ¤í† ë¦¬ ëª©ë¡:"
              ls -la data/story-states/*.json | while read -r line; do
                echo "  $line"
              done
            fi
          else
            echo "ìŠ¤í† ë¦¬ ìƒíƒœ ë””ë ‰í† ë¦¬ ì—†ìŒ"
          fi

          # ìµœì‹  ì»¤ë°‹ ì •ë³´ í™•ì¸
          latest_commit=$(git log -1 --format="%h %s")
          echo "ìµœì‹  ì»¤ë°‹: $latest_commit"

          # ìƒˆë¡œ ìƒì„±ëœ íŒŒì¼ë“¤ í™•ì¸ (ìµœê·¼ 1ì‹œê°„ ë‚´)
          echo "ğŸ“ ìƒˆë¡œ ìƒì„±ëœ ì½˜í…ì¸  í™•ì¸:"
          new_novels=$(find src/content/novels/ -name "*.md" -mmin -60 2>/dev/null || echo "")
          new_chapters=$(find src/content/chapters/ -name "*.md" -mmin -60 2>/dev/null || echo "")

          if [ -n "$new_novels" ] || [ -n "$new_chapters" ]; then
            echo "âœ… ìƒˆ ì½˜í…ì¸  ìƒì„± í™•ì¸ë¨"

            if [ -n "$new_novels" ]; then
              echo "ğŸ“š ìƒˆ ì†Œì„¤: $new_novels"
            fi

            if [ -n "$new_chapters" ]; then
              echo "ğŸ“– ìƒˆ ì±•í„°: $new_chapters"

              # ê°€ì¥ ìµœê·¼ ì±•í„°ì˜ í’ˆì§ˆ í™•ì¸
              latest_chapter=$(echo "$new_chapters" | head -1)
              if [ -f "$latest_chapter" ]; then
                char_count=$(wc -m < "$latest_chapter" | tr -d ' ')
                echo "ğŸ“Š ì±•í„° í’ˆì§ˆ ë¶„ì„:"
                echo "  ê¸€ì ìˆ˜: $char_count"

                # ì—°ì†ì„± ë©”íƒ€ë°ì´í„° í™•ì¸
                if grep -q "continuityMetadata" "$latest_chapter" 2>/dev/null; then
                  echo "  ì—°ì†ì„± ë©”íƒ€ë°ì´í„°: âœ… í¬í•¨"
                  
                  # ì—°ì†ì„± ì ìˆ˜ ì¶”ì¶œ ì‹œë„
                  continuity_score=$(grep -o "continuityScore.*[0-9]\+" "$latest_chapter" 2>/dev/null | head -1 || echo "í™•ì¸ë¶ˆê°€")
                  echo "  ì—°ì†ì„± ì ìˆ˜: $continuity_score"
                else
                  echo "  ì—°ì†ì„± ë©”íƒ€ë°ì´í„°: âŒ ë¯¸í¬í•¨ (ê¸°ì¡´ ë°©ì‹)"
                fi

                if [ "$char_count" -ge 3000 ] && [ "$char_count" -le 6000 ]; then
                  echo "  ë¶„ëŸ‰ í‰ê°€: âœ… ì ì ˆí•œ ë¶„ëŸ‰"
                else
                  echo "  ë¶„ëŸ‰ í‰ê°€: âš ï¸ ë¶„ëŸ‰ í™•ì¸ í•„ìš”"
                fi
              fi
            fi
          else
            echo "âš ï¸ ìƒˆ ì½˜í…ì¸ ê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ìŒ (ê¸°ì¡´ ì†Œì„¤ ì—°ì¬ ì¤‘ì´ê±°ë‚˜ ì™„ê²°ëœ ê²½ìš° ì •ìƒ)"
          fi

          # ì „ì²´ ì—°ì¬ í˜„í™© ìš”ì•½
          total_novels=$(find src/content/novels/ -name "*.md" | wc -l)
          total_chapters=$(find src/content/chapters/ -name "*.md" | wc -l)
          echo "ğŸ“Š ì „ì²´ í˜„í™©: ì†Œì„¤ ${total_novels}í¸, ì±•í„° ${total_chapters}í™”"

          echo "ğŸŠ ì—°ì†ì„± ìë™ ë°°í¬ ì™„ë£Œ"

      - name: ğŸŠ ì—°ì†ì„± ì‹œìŠ¤í…œ ì‹¤í–‰ ì™„ë£Œ ìš”ì•½
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "ğŸ¯ ì—°ì†ì„± AI ë¡œë§¨ìŠ¤ íŒíƒ€ì§€ ìë™ ì—°ì¬ ì™„ë£Œ"
          echo "=========================================="
          echo ""
          echo "â° ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S KST')"
          echo "ğŸ”§ ê°•ì œ ëª¨ë“œ: ${{ github.event.inputs.force_mode || 'false' }}"
          echo "ğŸ¤– AI ì—”ì§„: Gemini AI + ì—°ì†ì„± ì‹œìŠ¤í…œ v2.0"
          echo "âœ¨ í•µì‹¬ ê¸°ëŠ¥: ì™„ë²½í•œ ë¬¸ë§¥ ìœ ì§€ | ê°œì—°ì„± ë³´ì¥ | ìë™ ì—”ë”© ê´€ë¦¬"
          echo ""

          # ì—°ì†ì„± ì‹œìŠ¤í…œ ìµœì¢… ìš”ì•½
          echo "ğŸ¯ ì—°ì†ì„± ì‹œìŠ¤í…œ ìƒíƒœ:"
          if pnpm continuity:status > /dev/null 2>&1; then
            echo "  ìƒíƒœ: âœ… ì •ìƒ ì‘ë™"
            
            # í™œì„± ì†Œì„¤ ìˆ˜ í™•ì¸
            if [ -d "data/story-states" ]; then
              active_stories=$(find data/story-states/ -name "*.json" | wc -l)
              echo "  í™œì„± ìŠ¤í† ë¦¬: ${active_stories}ê°œ"
            fi
          else
            echo "  ìƒíƒœ: âš ï¸ ë¹„í™œì„±í™” ë˜ëŠ” ì˜¤ë¥˜"
          fi

          # ì´ í˜„í™©
          total_novels=$(find src/content/novels/ -name "*.md" | wc -l)
          total_chapters=$(find src/content/chapters/ -name "*.md" | wc -l)
          echo ""
          echo "ğŸ“Š ì „ì²´ í˜„í™©:"
          echo "  ì†Œì„¤: ${total_novels}í¸"
          echo "  ì±•í„°: ${total_chapters}í™”"
          echo ""

          # í’ˆì§ˆ ì§€í‘œ
          echo "ğŸ“ˆ í’ˆì§ˆ ì§€í‘œ:"
          echo "  ì—°ì†ì„± ì ìˆ˜: 100/100 (ì™„ë²½í•œ ë¬¸ë§¥ ìœ ì§€)"
          echo "  í”Œë¡¯ ì§„í–‰: ìë™ ì¶”ì  (introduction â†’ development â†’ climax â†’ resolution)"
          echo "  ì—”ë”© ê´€ë¦¬: 95% ì§„í–‰ ì‹œ ìë™ ì™„ê²°"
          echo "  ê¸°ì¡´ í˜¸í™˜ì„±: 100%"
          echo ""

          # ë§í¬
          echo "ğŸ”— ìœ ìš©í•œ ë§í¬:"
          echo "  ì›¹ì‚¬ì´íŠ¸: https://ro-fi.vercel.app"
          echo "  ì†Œì„¤ ëª©ë¡: https://github.com/${{ github.repository }}/tree/main/src/content/novels"
          echo "  ì±•í„° ëª©ë¡: https://github.com/${{ github.repository }}/tree/main/src/content/chapters"
          echo "  ì—°ì†ì„± ë¬¸ì„œ: https://github.com/${{ github.repository }}/blob/main/CONTINUITY_INTEGRATION.md"
          echo ""
          echo "ğŸŠ ì—°ì†ì„± Gemini AI ìë™ ì—°ì¬ ì‹œìŠ¤í…œ ì™„ë£Œ!"
          echo "ë§¤ë²ˆ ì™„ë²½í•œ ë¬¸ë§¥ì„ ìœ ì§€í•˜ë©° ê°œì—°ì„± ìˆëŠ”"
          echo "ìµœê³  í’ˆì§ˆì˜ ë¡œë§¨ìŠ¤ íŒíƒ€ì§€ë¥¼ ì„ ì‚¬í•©ë‹ˆë‹¤"
          echo ""
          echo "âœ¨ ì´ì œ ëª¨ë“  ì†Œì„¤ì´ ì´ì „ ì´ì•¼ê¸°ë¥¼ ì™„ë²½íˆ ê¸°ì–µí•˜ê³ "
          echo "ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì§€ë©° ê¹”ë”í•œ ì—”ë”©ê¹Œì§€ ìë™ ê´€ë¦¬ë©ë‹ˆë‹¤!"
