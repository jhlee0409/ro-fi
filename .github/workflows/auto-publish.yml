name: ìë™ ë¡œíŒ ì—°ì¬ ì‹œìŠ¤í…œ (Romance Fantasy Auto Publisher)

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œ, ì˜¤í›„ 3ì‹œ, ì˜¤í›„ 9ì‹œ KST ì‹¤í–‰ (UTC ê¸°ì¤€ 00:00, 06:00, 12:00)
    - cron: '0 0,6,12 * * *'
  workflow_dispatch:
    inputs:
      action_type:
        description: 'ì‹¤í–‰í•  ì•¡ì…˜ íƒ€ì…'
        required: true
        default: 'auto'
        type: choice
        options:
        - auto
        - new_novel_only
        - continue_only
        - complete_only
      verbose:
        description: 'ìƒì„¸ ë¡œê·¸ ì¶œë ¥'
        required: false
        default: false
        type: boolean

jobs:
  automation:
    runs-on: ubuntu-latest
    
    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      NODE_ENV: production
    
    steps:
    - name: ğŸ›’ ì²´í¬ì•„ì›ƒ ì½”ë“œ
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: ğŸ”§ pnpm ì„¤ì¹˜
      uses: pnpm/action-setup@v4
      with:
        version: 8
    
    - name: ğŸ“¦ Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'
    
    - name: ğŸ“š ì˜ì¡´ì„± ì„¤ì¹˜
      run: pnpm install --ignore-scripts
    
    - name: ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: |
        pnpm test
        pnpm test:e2e --reporter=list
      continue-on-error: false
    
    - name: ğŸ” ë³´ì•ˆ ê²€ì‚¬
      run: |
        pnpm security:audit
        pnpm lint
      continue-on-error: true
    
    - name: ğŸš€ ìë™í™” ì‹¤í–‰
      id: automation
      run: |
        if [[ "${{ github.event.inputs.verbose }}" == "true" ]]; then
          node scripts/run-automation.js --verbose
        else
          node scripts/run-automation.js
        fi
      continue-on-error: false
    
    - name: ğŸ“Š ê²°ê³¼ ì—…ë¡œë“œ (Artifacts)
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: automation-results-${{ github.run_number }}
        path: |
          logs/
          src/content/
          test-results/
        retention-days: 30
    
    - name: ğŸ¯ Git ì„¤ì •
      if: success()
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "ë¡œíŒ ìë™í™” ë´‡ ğŸ¤–"
    
    - name: ğŸ“ ë³€ê²½ì‚¬í•­ ì»¤ë°‹
      if: success()
      run: |
        git add src/content/
        git add logs/
        
        # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
        if git diff --staged --quiet; then
          echo "ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤. ì»¤ë°‹ì„ ê±´ë„ˆëœë‹ˆë‹¤."
          exit 0
        fi
        
        # ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±
        TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S KST')
        AUTOMATION_LOG=$(tail -n 20 logs/automation-report-$(date '+%Y-%m-%d').json | grep -o '"summary":[^}]*}' | head -1 || echo '"summary": {"activeNovels": "N/A"}')
        
        git commit -m "ğŸ¤– ìë™ ì—°ì¬ ì—…ë°ì´íŠ¸ - $TIMESTAMP

        $AUTOMATION_LOG
        
        ğŸ¤– Generated with Claude AI Automation System
        Co-Authored-By: Claude <noreply@anthropic.com>"
    
    - name: ğŸ“¤ GitHubì— í‘¸ì‹œ
      if: success()
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}
    
    - name: ğŸ”” ì•Œë¦¼ (ì„±ê³µì‹œ)
      if: success()
      run: |
        echo "::notice title=ìë™í™” ì„±ê³µ::ë¡œë§¨ìŠ¤ íŒíƒ€ì§€ ìë™ ì—°ì¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰"
    
    - name: âŒ ì•Œë¦¼ (ì‹¤íŒ¨ì‹œ)
      if: failure()
      run: |
        echo "::error title=ìë™í™” ì‹¤íŒ¨::ë¡œë§¨ìŠ¤ íŒíƒ€ì§€ ìë™ ì—°ì¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."

  deploy:
    needs: automation
    if: success()
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ›’ ì²´í¬ì•„ì›ƒ (ìµœì‹  ë³€ê²½ì‚¬í•­ í¬í•¨)
      uses: actions/checkout@v4
      with:
        ref: ${{ github.ref }}
        fetch-depth: 0
    
    - name: ğŸ”§ pnpm ì„¤ì¹˜
      uses: pnpm/action-setup@v4
      with:
        version: 8
    
    - name: ğŸ“¦ Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'
    
    - name: ğŸ“š ì˜ì¡´ì„± ì„¤ì¹˜
      run: pnpm install --ignore-scripts
    
    - name: ğŸ—ï¸ Astro ë¹Œë“œ
      run: pnpm build
      env:
        NODE_ENV: production
    
    - name: ğŸš€ Vercel ë°°í¬
      uses: amondnet/vercel-action@v25
      if: github.ref == 'refs/heads/main'
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        vercel-args: '--prod'
        working-directory: .
    
    - name: ğŸ‰ ë°°í¬ ì™„ë£Œ ì•Œë¦¼
      if: success()
      run: |
        echo "::notice title=ë°°í¬ ì™„ë£Œ::ìƒˆë¡œìš´ ì½˜í…ì¸ ê°€ ë¼ì´ë¸Œ ì‚¬ì´íŠ¸ì— ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤! âœ¨"

  health_check:
    needs: [automation, deploy]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ¥ ì‹œìŠ¤í…œ ìƒíƒœ ì²´í¬
      run: |
        if [[ "${{ needs.automation.result }}" == "success" && "${{ needs.deploy.result }}" == "success" ]]; then
          echo "::notice title=ì‹œìŠ¤í…œ ì •ìƒ::ëª¨ë“  ìë™í™” í”„ë¡œì„¸ìŠ¤ê°€ ì •ìƒì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸŸ¢"
        elif [[ "${{ needs.automation.result }}" == "failure" ]]; then
          echo "::error title=ìë™í™” ì‹¤íŒ¨::ì½˜í…ì¸  ìƒì„± í”„ë¡œì„¸ìŠ¤ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ğŸ”´"
          exit 1
        elif [[ "${{ needs.deploy.result }}" == "failure" ]]; then
          echo "::warning title=ë°°í¬ ì‹¤íŒ¨::ì½˜í…ì¸ ëŠ” ìƒì„±ë˜ì—ˆìœ¼ë‚˜ ë°°í¬ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ğŸŸ¡"
        else
          echo "::warning title=ë¶€ë¶„ ì„±ê³µ::ì¼ë¶€ í”„ë¡œì„¸ìŠ¤ê°€ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ğŸŸ¡"
        fi