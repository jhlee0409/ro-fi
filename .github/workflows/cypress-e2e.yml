# Cypress E2E Testing Workflow
name: Cypress E2E Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©
    inputs:
      browser:
        description: 'Browser to run tests in'
        required: false
        default: 'chrome'
        type: choice
        options:
          - chrome
          - firefox
          - edge
      spec:
        description: 'Specific spec file to run (optional)'
        required: false
        type: string

jobs:
  cypress-e2e:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        browser: [chrome, firefox]
        # ë³‘ë ¬ ì‹¤í–‰ì„ ìœ„í•œ ìŠ¤í™ ë¶„í•  (ì„ íƒì )
        spec-group: [1, 2]
    
    steps:
      - name: ğŸ›’ ì²´í¬ì•„ì›ƒ ì½”ë“œ
        uses: actions/checkout@v4

      - name: ğŸ”§ Node.js + pnpm í™˜ê²½ ì„¤ì •
        uses: ./.github/actions/setup-node-pnpm
        with:
          install-deps: 'true'

      - name: ğŸ“¦ Cypress ë°”ì´ë„ˆë¦¬ ìºì‹œ
        uses: actions/cache@v4
        with:
          path: ~/.cache/Cypress
          key: cypress-${{ runner.os }}-${{ hashFiles('package.json') }}
          restore-keys: |
            cypress-${{ runner.os }}-

      - name: ğŸ—ï¸ Astro í”„ë¡œì íŠ¸ ë¹Œë“œ
        run: pnpm build

      - name: ğŸš€ Astro ê°œë°œ ì„œë²„ ì‹œì‘ (ë°±ê·¸ë¼ìš´ë“œ)
        run: |
          pnpm dev &
          sleep 30 # ì„œë²„ ì‹œì‘ ëŒ€ê¸°
        env:
          NODE_ENV: test
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: ğŸ” ì„œë²„ ìƒíƒœ í™•ì¸
        run: |
          curl --retry 10 --retry-delay 3 --retry-connrefused http://localhost:4321
          echo "âœ… Astro ì„œë²„ê°€ ì •ìƒì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤"

      - name: ğŸ§ª Cypress E2E í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        uses: cypress-io/github-action@v6
        with:
          browser: ${{ matrix.browser }}
          spec: |
            ${{ github.event.inputs.spec || 
                (matrix.spec-group == 1 && 'cypress/e2e/homepage.cy.ts,cypress/e2e/novels.cy.ts' ||
                 'cypress/e2e/novel-detail.cy.ts,cypress/e2e/automation-workflow.cy.ts,cypress/e2e/platform-optimization.cy.ts') }}
          config: baseUrl=http://localhost:4321
          wait-on: 'http://localhost:4321'
          wait-on-timeout: 120
          install: false # ì´ë¯¸ ì„¤ì¹˜ë¨
        env:
          # Cypress í™˜ê²½ ë³€ìˆ˜
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
          CYPRESS_PROJECT_ID: ${{ secrets.CYPRESS_PROJECT_ID }}
          # ì• í”Œë¦¬ì¼€ì´ì…˜ í™˜ê²½ ë³€ìˆ˜
          NODE_ENV: test
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          # í…ŒìŠ¤íŠ¸ ì„¤ì •
          CYPRESS_MOCK_AI: true
          CYPRESS_PLATFORM_MODE: default

      - name: ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-screenshots-videos-${{ matrix.browser }}-${{ matrix.spec-group }}
          path: |
            cypress/screenshots
            cypress/videos
          retention-days: 7

      - name: ğŸ“ˆ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        uses: codecov/codecov-action@v4
        if: matrix.browser == 'chrome' && matrix.spec-group == 1
        with:
          files: ./coverage/lcov.info
          flags: e2e
          name: cypress-e2e-coverage
          fail_ci_if_error: false

  cypress-component:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ›’ ì²´í¬ì•„ì›ƒ ì½”ë“œ
        uses: actions/checkout@v4

      - name: ğŸ”§ Node.js + pnpm í™˜ê²½ ì„¤ì •
        uses: ./.github/actions/setup-node-pnpm
        with:
          install-deps: 'true'

      - name: ğŸ§ª Cypress ì»´í¬ë„ŒíŠ¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        uses: cypress-io/github-action@v6
        with:
          component: true
          browser: chrome
          install: false
        env:
          NODE_ENV: test

      - name: ğŸ“Š ì»´í¬ë„ŒíŠ¸ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-component-screenshots
          path: cypress/screenshots
          retention-days: 7

  accessibility-tests:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ›’ ì²´í¬ì•„ì›ƒ ì½”ë“œ
        uses: actions/checkout@v4

      - name: ğŸ”§ Node.js + pnpm í™˜ê²½ ì„¤ì •
        uses: ./.github/actions/setup-node-pnpm
        with:
          install-deps: 'true'

      - name: ğŸ—ï¸ Astro í”„ë¡œì íŠ¸ ë¹Œë“œ
        run: pnpm build

      - name: ğŸš€ Astro ê°œë°œ ì„œë²„ ì‹œì‘
        run: |
          pnpm dev &
          sleep 30

      - name: â™¿ ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        uses: cypress-io/github-action@v6
        with:
          browser: chrome
          spec: cypress/e2e/**/*.cy.ts
          config: |
            baseUrl=http://localhost:4321,
            env: {
              accessibility_test_only: true
            }
          install: false
        env:
          NODE_ENV: test
          CYPRESS_ACCESSIBILITY_ONLY: true

      - name: ğŸ“Š ì ‘ê·¼ì„± ë¦¬í¬íŠ¸ ìƒì„±
        run: |
          echo "ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸ ì™„ë£Œ" > accessibility-report.txt
          echo "ìœ„ë°˜ ì‚¬í•­: ${{ steps.cypress.outputs.violations || '0' }}" >> accessibility-report.txt

      - name: ğŸ“ˆ ì ‘ê·¼ì„± ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-report
          path: accessibility-report.txt

  test-summary:
    runs-on: ubuntu-latest
    needs: [cypress-e2e, cypress-component, accessibility-tests]
    if: always()
    
    steps:
      - name: ğŸ“‹ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
        run: |
          echo "## ğŸ§ª Cypress E2E í…ŒìŠ¤íŠ¸ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| í…ŒìŠ¤íŠ¸ ìœ í˜• | ìƒíƒœ |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| E2E í…ŒìŠ¤íŠ¸ | ${{ needs.cypress-e2e.result == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ì»´í¬ë„ŒíŠ¸ í…ŒìŠ¤íŠ¸ | ${{ needs.cypress-component.result == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸ | ${{ needs.accessibility-tests.result == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.cypress-e2e.result }}" == "success" && 
                "${{ needs.cypress-component.result }}" == "success" && 
                "${{ needs.accessibility-tests.result }}" == "success" ]]; then
            echo "ğŸ‰ ëª¨ë“  Cypress í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ ì¼ë¶€ í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”." >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ’¬ PR ì½”ë©˜íŠ¸ (ì‹¤íŒ¨ ì‹œ)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ§ª Cypress E2E í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨
              
              ì¼ë¶€ E2E í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ [Actions íƒ­](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})ì—ì„œ í™•ì¸í•´ì£¼ì„¸ìš”.
              
              ### ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸:
              - E2E í…ŒìŠ¤íŠ¸: ${{ needs.cypress-e2e.result }}
              - ì»´í¬ë„ŒíŠ¸ í…ŒìŠ¤íŠ¸: ${{ needs.cypress-component.result }}
              - ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸: ${{ needs.accessibility-tests.result }}
              
              ìŠ¤í¬ë¦°ìƒ·ê³¼ ë¹„ë””ì˜¤ëŠ” ì•„í‹°íŒ©íŠ¸ì—ì„œ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`
            })