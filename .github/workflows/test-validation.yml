# í…ŒìŠ¤íŠ¸ ê²€ì¦ ì›Œí¬í”Œë¡œìš° (ë…ë¦½ ì‹¤í–‰)
name: Test Validation

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ›’ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ”§ pnpm ì„¤ì¹˜
      uses: pnpm/action-setup@v4
      with:
        version: 8
    
    - name: ğŸ“¦ Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'
    
    - name: ğŸ“š ì˜ì¡´ì„± ì„¤ì¹˜ (ì „ì²´)
      run: |
        echo "ğŸ” ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
        pnpm install
        echo "âœ… ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"
        
        echo "ğŸ“‹ ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€ ì •ë³´:"
        pnpm list --depth=0 | grep vitest || echo "vitest íŒ¨í‚¤ì§€ ì—†ìŒ"
        
        # vitest ë°”ì´ë„ˆë¦¬ í™•ì¸
        if [ -f "node_modules/.bin/vitest" ]; then
          echo "âœ… vitest ë°”ì´ë„ˆë¦¬ í™•ì¸ë¨"
          ls -la node_modules/.bin/vitest
        else
          echo "âŒ vitest ë°”ì´ë„ˆë¦¬ ì—†ìŒ"
          echo "node_modules/.bin ë””ë ‰í† ë¦¬ ë‚´ìš©:"
          ls -la node_modules/.bin/ | head -20
          
          echo "vitest ìˆ˜ë™ ì„¤ì¹˜ ì‹œë„:"
          pnpm add vitest@latest --save-dev
        fi
        
        # PATHì— ì¶”ê°€
        echo "$PWD/node_modules/.bin" >> $GITHUB_PATH
    
    - name: ğŸ§ª Unit í…ŒìŠ¤íŠ¸
      run: |
        echo "ğŸ§ª Unit í…ŒìŠ¤íŠ¸ ì‹œì‘..."
        
        # ì—¬ëŸ¬ ë°©ë²•ìœ¼ë¡œ vitest ì‹¤í–‰ ì‹œë„
        if [ -f "node_modules/.bin/vitest" ]; then
          echo "âœ… ì§ì ‘ ê²½ë¡œë¡œ vitest ì‹¤í–‰"
          ./node_modules/.bin/vitest --run --reporter=verbose
        elif command -v vitest >/dev/null 2>&1; then
          echo "âœ… PATHì—ì„œ vitest ì‹¤í–‰"
          vitest --run --reporter=verbose
        elif [ -f "node_modules/vitest/dist/cli.js" ]; then
          echo "âœ… nodeë¡œ vitest ì§ì ‘ ì‹¤í–‰"
          node node_modules/vitest/dist/cli.js --run --reporter=verbose
        else
          echo "âš ï¸ vitest ì—†ìŒ, npxë¡œ ìµœì¢… ì‹œë„"
          npx vitest@latest --run --reporter=verbose
        fi
      continue-on-error: false
    
    - name: ğŸ­ E2E í…ŒìŠ¤íŠ¸ (Playwright)
      run: |
        echo "ğŸ­ E2E í…ŒìŠ¤íŠ¸ ì‹œì‘..."
        pnpm test:e2e --reporter=list
      continue-on-error: true
    
    - name: ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ github.run_number }}
        path: |
          test-results/
          coverage/
        retention-days: 7
    
    - name: âœ… í…ŒìŠ¤íŠ¸ ì„±ê³µ ì•Œë¦¼
      if: success()
      run: |
        echo "::notice title=í…ŒìŠ¤íŠ¸ ì„±ê³µ::ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ í†µê³¼í–ˆìŠµë‹ˆë‹¤! ğŸ‰"
    
    - name: âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì•Œë¦¼
      if: failure()
      run: |
        echo "::error title=í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨::ì¼ë¶€ í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."