# 테스트 검증 워크플로우 (독립 실행)
name: Test Validation

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: 🛒 체크아웃
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🔧 pnpm 설치
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: 📦 Node.js 설정
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: 📚 의존성 설치 (전체)
        run: pnpm install

      - name: 🎨 코드 스타일 검사 (Lint)
        run: pnpm lint

      - name: ʦ 타입 검사 (TypeScript)
        run: pnpm type-check

      - name: 🧪 Unit 테스트
        run: |
          echo "🧪 Unit 테스트 시작..."
          # pnpm은 자동으로 node_modules/.bin을 PATH에 추가하므로
          # package.json의 'test' 스크립트를 바로 실행할 수 있습니다.
          # '-- --reporter=verbose'는 vitest에 인자를 전달하여 상세 로그를 봅니다.
          pnpm test -- --reporter=verbose
        continue-on-error: false
      - name: 📊 테스트 결과 업로드
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ github.run_number }}
          path: |
            test-results/
            coverage/
          retention-days: 7

      - name: ✅ 테스트 성공 알림
        if: success()
        run: |
          echo "::notice title=테스트 성공::모든 테스트가 성공적으로 통과했습니다! 🎉"

      - name: ❌ 테스트 실패 알림
        if: failure()
        run: |
          echo "::error title=테스트 실패::일부 테스트가 실패했습니다. 로그를 확인해주세요."
