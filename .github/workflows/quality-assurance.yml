# BASE.md í’ˆì§ˆ ë³´ì¦ ì‹œìŠ¤í…œ: 7.5/10 ì´ìƒ í•„ìˆ˜
name: Quality Assurance Check

on:
  pull_request:
    paths:
      - "src/content/chapters/**/*.md"
      - "src/content/novels/**/*.md"
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      force_check:
        description: 'Force quality check even without file changes'
        required: false
        default: false
        type: boolean
  schedule:
    - cron: '30 2 * * *'  # ë§¤ì¼ ìƒˆë²½ 2:30 (ìë™í™” ì´í›„ í’ˆì§ˆ ê²€ì‚¬)

jobs:
  quality-check:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: ğŸ”§ Node.js + pnpm í™˜ê²½ ì„¤ì •
        uses: ./.github/actions/setup-node-pnpm
        with:
          install-deps: 'false'
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Validate API Key
        run: |
          if [ -z "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
            echo "âŒ ANTHROPIC_API_KEY ì‹œí¬ë¦¿ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            echo "GitHub Repository Settings > Secretsì—ì„œ ANTHROPIC_API_KEYë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”."
            exit 1
          else
            echo "âœ… API í‚¤ í™•ì¸ë¨"
          fi

      - name: Check Content Files
        id: check_files
        run: |
          # ê²€í† í•  íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
          if [ -d "src/content/chapters" ] && [ -d "src/content/novels" ]; then
            chapter_count=$(find src/content/chapters -name "*.md" | wc -l)
            novel_count=$(find src/content/novels -name "*.md" | wc -l)
            echo "âœ… ì»¨í…ì¸  í´ë” í™•ì¸ë¨ - ì†Œì„¤: ${novel_count}í¸, ì±•í„°: ${chapter_count}í™”"
            echo "has_content=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ ì»¨í…ì¸  í´ë”ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
            echo "has_content=false" >> $GITHUB_OUTPUT
          fi

      - name: AI Quality Review with Claude Code
        id: claude_review
        if: steps.check_files.outputs.has_content == 'true'
        continue-on-error: true
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          direct_prompt: |
            # ë¡œë§¨ìŠ¤ íŒíƒ€ì§€ í’ˆì§ˆ ê²€ì¦ ì‹œìŠ¤í…œ

            ## ëª©í‘œ: ìƒˆë¡œ ìƒì„±ëœ ì±•í„°ë“¤ì˜ í’ˆì§ˆì„ ë¡œíŒ ë…ì ê¸°ì¤€ìœ¼ë¡œ ê²€ì¦

            ## 1ë‹¨ê³„: ë³€ê²½ëœ íŒŒì¼ í™•ì¸
            - ìµœê·¼ ì»¤ë°‹ì—ì„œ ìˆ˜ì •/ì¶”ê°€ëœ .md íŒŒì¼ë“¤ ì‹ë³„
            - src/content/chapters/ ë‚´ì˜ ìƒˆ ì±•í„° íŒŒì¼ë“¤ ìš°ì„  ê²€í† 

            ## 2ë‹¨ê³„: ë¡œë§¨ìŠ¤ íŒíƒ€ì§€ í’ˆì§ˆ í‰ê°€ (ê° í•­ëª© 0-10ì )

            ### í‰ê°€ ê¸°ì¤€:
            1. **ë§ˆí¬ë‹¤ìš´ í¬ë§· ì¤€ìˆ˜** (0-10ì ) â­ **í•„ìˆ˜**
               - ëŒ€í™”ì²´: `> "ë‚´ìš©"` í˜•ì‹ ì¤€ìˆ˜ ì—¬ë¶€
               - ë…ë°±: `> *'ë‚´ìš©'*` í˜•ì‹ ì¤€ìˆ˜ ì—¬ë¶€  
               - ì•¡ì…˜: `> [í–‰ë™ì„¤ëª…]` í˜•ì‹ ì¤€ìˆ˜ ì—¬ë¶€
               - ì„œìˆ : ì¤‘ìš” í‚¤ì›Œë“œ **ë³¼ë“œ** ì²˜ë¦¬ ì—¬ë¶€
               - í•œ ì¤„ì— í•˜ë‚˜ ìš”ì†Œë§Œ í¬í•¨ ì›ì¹™ ì¤€ìˆ˜
               - ë”°ì˜´í‘œ ê·œì¹™ (ëŒ€í™”=", ë…ë°±=') ì¤€ìˆ˜

            2. **ë¡œë§¨ìŠ¤ ëª°ì…ë„** (0-10ì )
               - ì£¼ì¸ê³µë“¤ ê°„ì˜ ê°ì •ì  ê¸´ì¥ê°
               - ë¡œë§¨í‹±í•œ ìƒí™©ê³¼ ëŒ€í™”ì˜ ìì—°ìŠ¤ëŸ¬ì›€
               - ë…ìì˜ ì„¤ë ˜ ìœ ë°œ ì •ë„

            3. **íŒíƒ€ì§€ ì„¸ê³„ê´€ ì¼ê´€ì„±** (0-10ì )
               - ë§ˆë²•/íŒíƒ€ì§€ ì„¤ì •ì˜ ë…¼ë¦¬ì„±
               - ì´ì „ ì±•í„°ì™€ì˜ ì„¤ì • ì—°ì†ì„±
               - ì„¸ê³„ê´€ ë‚´ ê·œì¹™ ì¤€ìˆ˜

            4. **ìºë¦­í„° ë§¤ë ¥ë„** (0-10ì )
               - ì£¼ì¸ê³µ/ì¡°ì—°ì˜ ê°œì„±ê³¼ ë§¤ë ¥
               - ìºë¦­í„° í–‰ë™ì˜ ì¼ê´€ì„±
               - ëŒ€í™”ì™€ í–‰ë™ì˜ ê°œì—°ì„±

            5. **ë¬¸ì¥ ê°€ë…ì„±** (0-10ì )
               - ë¬¸ë²•ê³¼ ë§ì¶¤ë²• ì •í™•ì„±
               - ë¬¸ì¥ì˜ ìì—°ìŠ¤ëŸ¬ì›€ê³¼ ìœ ë ¤í•¨
               - ì ì ˆí•œ ë¬¸ì²´ì™€ ì–´ì¡°

            6. **ë‹¤ìŒí™” ê¸°ëŒ€ê°** (0-10ì )
               - í´ë¦¬í”„í–‰ì–´ì˜ íš¨ê³¼ì„±
               - ìŠ¤í† ë¦¬ ì§„í–‰ì˜ í¥ë¯¸ë¡œì›€
               - ë…ìì˜ ê¶ê¸ˆì¦ ìœ ë°œ

            ## 3ë‹¨ê³„: ì ìˆ˜ ê³„ì‚° ë° íŒì •
            - ì´ì  = (ê° í•­ëª© ì ìˆ˜ í•©ê³„) / 6
            - **í•©ê²© ê¸°ì¤€: 7.5/10 ì´ìƒ**
            - **ë§ˆí¬ë‹¤ìš´ í¬ë§· ì¤€ìˆ˜ëŠ” 8.0/10 ì´ìƒ í•„ìˆ˜** (í¬ë§· ë¶ˆì¼ì¹˜ ì‹œ ìë™ ì¬ì‘ì„±)
            - ë¶ˆí•©ê²© ì‹œ êµ¬ì²´ì ì¸ ê°œì„  ì‚¬í•­ ì œì‹œ

            ## 4ë‹¨ê³„: ê²°ê³¼ ì²˜ë¦¬
            ### í•©ê²© (7.5ì  ì´ìƒ):
            - âœ… í’ˆì§ˆ ê²€ì¦ í†µê³¼ ì½”ë©˜íŠ¸ ì¶”ê°€
            - ì •ì‹ ë°°í¬ ìŠ¹ì¸

            ### ë¶ˆí•©ê²© (7.5ì  ë¯¸ë§Œ):
            - âŒ í’ˆì§ˆ ê°œì„  í•„ìš” ì´ìŠˆ ìƒì„±
            - êµ¬ì²´ì ì¸ ë¬¸ì œì ê³¼ ê°œì„  ë°©í–¥ ì œì‹œ
            - ì¬ìƒì„± ìš”ì²­ í”Œë˜ê·¸ ì„¤ì •

            ## 5ë‹¨ê³„: ìë™ ê°œì„  (ì„ íƒì‚¬í•­)
            7.0ì  ì´ìƒ 7.5ì  ë¯¸ë§Œì¸ ê²½ìš°:
            - ì§€ì ëœ ë¬¸ì œì ì„ ìë™ìœ¼ë¡œ ìˆ˜ì • ì‹œë„
            - ìˆ˜ì •ëœ ë²„ì „ìœ¼ë¡œ íŒŒì¼ ì—…ë°ì´íŠ¸

            ## ì‹¤í–‰ ëª…ë ¹
            ìœ„ ê¸°ì¤€ìœ¼ë¡œ ìµœê·¼ ì¶”ê°€/ìˆ˜ì •ëœ ë¡œë§¨ìŠ¤ íŒíƒ€ì§€ ì±•í„°ë“¤ì„ ì§€ê¸ˆ ê²€ì¦í•˜ì„¸ìš”.
            ê° ì±•í„°ë³„ë¡œ ìƒì„¸í•œ ì ìˆ˜ì™€ í‰ê°€ ì´ìœ ë¥¼ ì œê³µí•˜ê³ , í•„ìš”ì‹œ ê°œì„  ì‚¬í•­ì„ êµ¬ì²´ì ìœ¼ë¡œ ì œì•ˆí•˜ì„¸ìš”.

      - name: ğŸ”§ Node.js í™˜ê²½ ì„¤ì • (í´ë°±ìš©)
        if: steps.claude_review.outcome == 'failure'
        uses: ./.github/actions/setup-node-pnpm
        with:
          install-deps: 'false'

      - name: Alternative AI Quality Check
        id: alternative_check
        if: steps.claude_review.outcome == 'failure'
        continue-on-error: true
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ğŸ”„ Claude Code Action ì‹¤íŒ¨ - ëŒ€ì•ˆ API í˜¸ì¶œ ì‹œë„"
          
          # ìµœì‹  ì±•í„° íŒŒì¼ ì°¾ê¸°
          latest_chapter=$(find src/content/chapters -name "*.md" -type f -exec ls -t {} + | head -1)
          
          if [[ -n "$latest_chapter" && -f "$latest_chapter" ]]; then
            echo "ğŸ“– ê²€í† í•  íŒŒì¼: $latest_chapter"
            
            # íŒŒì¼ ë‚´ìš© ì½ê¸°
            content=$(cat "$latest_chapter")
            char_count=$(echo "$content" | wc -m | tr -d ' ')
            
            echo "ğŸ“Š íŒŒì¼ ì •ë³´:"
            echo "  - ê¸€ì ìˆ˜: $char_count"
            echo "  - íŒŒì¼ í¬ê¸°: $(du -h "$latest_chapter" | cut -f1)"
            
            # ê¸°ë³¸ í’ˆì§ˆ ì ìˆ˜ ê³„ì‚°
            score=0
            
            # ë©”íƒ€ë°ì´í„° ì²´í¬ (2ì )
            if echo "$content" | head -10 | grep -q "^title:"; then
              score=$((score + 2))
              echo "âœ… ë©”íƒ€ë°ì´í„° ì¡´ì¬: +2ì "
            else
              echo "âŒ ë©”íƒ€ë°ì´í„° ëˆ„ë½: +0ì "
            fi
            
            # ê¸€ì ìˆ˜ ì²´í¬ (2ì )
            if [[ $char_count -ge 3000 ]]; then
              score=$((score + 2))
              echo "âœ… ì ì ˆí•œ ë¶„ëŸ‰ ($char_count >= 3000): +2ì "
            else
              echo "âŒ ë¶„ëŸ‰ ë¶€ì¡± ($char_count < 3000): +0ì "
            fi
            
            # ë§ˆí¬ë‹¤ìš´ í˜•ì‹ ì²´í¬ (3ì )
            dialogue_count=$(grep -c '^> "' "$latest_chapter" || echo 0)
            action_count=$(grep -c '^> \[' "$latest_chapter" || echo 0)
            monologue_count=$(grep -c "^> _'" "$latest_chapter" || echo 0)
            
            if [[ $dialogue_count -gt 0 && $action_count -gt 0 ]]; then
              score=$((score + 3))
              echo "âœ… ë§ˆí¬ë‹¤ìš´ í˜•ì‹ ì¤€ìˆ˜ (ëŒ€í™”:$dialogue_count, ì•¡ì…˜:$action_count, ë…ë°±:$monologue_count): +3ì "
            else
              score=$((score + 1))
              echo "âš ï¸ ë§ˆí¬ë‹¤ìš´ í˜•ì‹ ë¶€ë¶„ ì¤€ìˆ˜: +1ì "
            fi
            
            # êµ¬ì¡°í™” ì²´í¬ (1ì )
            if grep -q "^##" "$latest_chapter"; then
              score=$((score + 1))
              echo "âœ… ì¥ë©´ êµ¬ë¶„ ì¡´ì¬: +1ì "
            else
              echo "âŒ ì¥ë©´ êµ¬ë¶„ ì—†ìŒ: +0ì "
            fi
            
            # í•œê¸€ ì»¨í…ì¸  ì²´í¬ (2ì )
            korean_chars=$(echo "$content" | grep -o '[ê°€-í£]' | wc -l | tr -d ' ')
            if [[ $korean_chars -gt 1000 ]]; then
              score=$((score + 2))
              echo "âœ… í•œê¸€ ì½˜í…ì¸  ì¶©ë¶„ ($korean_chars chars): +2ì "
            else
              echo "âš ï¸ í•œê¸€ ì½˜í…ì¸  ë¶€ì¡± ($korean_chars chars): +1ì "
              score=$((score + 1))
            fi
            
            # bcê°€ ì—†ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ bash ì‚°ìˆ  ì‚¬ìš©
            total_score=$(awk "BEGIN {printf \"%.1f\", $score}")
            echo "ğŸ“Š ìµœì¢… ì ìˆ˜: $total_score/10"
            
            # 7.5 ì´ìƒì¸ì§€ ì²´í¬ (75 ì´ìƒìœ¼ë¡œ ì •ìˆ˜ ë¹„êµ)
            score_int=$(awk "BEGIN {printf \"%.0f\", $score * 10}")
            if [[ $score_int -ge 75 ]]; then
              echo "âœ… í’ˆì§ˆ ê²€ì¦ í†µê³¼"
              echo "quality_passed=true" >> $GITHUB_OUTPUT
            else
              echo "âŒ í’ˆì§ˆ ê¸°ì¤€ ë¯¸ë‹¬ ($total_score < 7.5)"
              echo "quality_passed=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸ ê²€í† í•  ì±•í„° íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
            echo "quality_passed=true" >> $GITHUB_OUTPUT
          fi

      - name: Basic Fallback Quality Check
        if: steps.claude_review.outcome == 'failure' && steps.alternative_check.outcome == 'failure'
        run: |
          echo "ğŸ”„ ëª¨ë“  AI ê²€ì¦ ì‹¤íŒ¨ - ê¸°ë³¸ í’ˆì§ˆ ê²€ì‚¬ ì‹¤í–‰"
          
          # ê¸°ë³¸ì ì¸ ë§ˆí¬ë‹¤ìš´ í˜•ì‹ ê²€ì‚¬
          echo "ğŸ“ ê¸°ë³¸ ë§ˆí¬ë‹¤ìš´ í˜•ì‹ ê²€ì‚¬..."
          
          failed_files=()
          for file in src/content/chapters/*.md; do
            if [[ -f "$file" ]]; then
              echo "ê²€ì‚¬ ì¤‘: $file"
              
              # ê¸°ë³¸ ë©”íƒ€ë°ì´í„° í™•ì¸
              if ! head -10 "$file" | grep -q "^title:"; then
                echo "âŒ $file: ì œëª© ë©”íƒ€ë°ì´í„° ëˆ„ë½"
                failed_files+=("$file")
              fi
              
              # ìµœì†Œ ê¸€ì ìˆ˜ í™•ì¸ (3000ì ì´ìƒ)
              char_count=$(wc -m < "$file" | tr -d ' ')
              if [[ $char_count -lt 3000 ]]; then
                echo "âŒ $file: ê¸€ì ìˆ˜ ë¶€ì¡± ($char_count < 3000)"
                failed_files+=("$file")
              else
                echo "âœ… $file: ê¸€ì ìˆ˜ ì ì ˆ ($char_count)"
              fi
            fi
          done
          
          if [[ ${#failed_files[@]} -eq 0 ]]; then
            echo "âœ… ê¸°ë³¸ í’ˆì§ˆ ê²€ì‚¬ í†µê³¼"
          else
            echo "âŒ í’ˆì§ˆ ê²€ì‚¬ ì‹¤íŒ¨í•œ íŒŒì¼ë“¤: ${failed_files[*]}"
            exit 1
          fi

      - name: Action Status Summary
        if: always()
        run: |
          echo "ğŸ“Š í’ˆì§ˆ ê²€ì¦ ê²°ê³¼ ìš”ì•½"
          echo "========================"
          
          # ê° ë‹¨ê³„ë³„ ê²°ê³¼ í™•ì¸
          if [[ "${{ steps.check_files.outputs.has_content }}" != "true" ]]; then
            echo "â­ï¸ ê²€ì¦í•  ì½˜í…ì¸  ì—†ìŒ"
          elif [[ "${{ steps.claude_review.outcome }}" == "success" ]]; then
            echo "âœ… Claude Code AI í’ˆì§ˆ ê²€ì¦ ì„±ê³µ"
          elif [[ "${{ steps.alternative_check.outcome }}" == "success" ]]; then
            if [[ "${{ steps.alternative_check.outputs.quality_passed }}" == "true" ]]; then
              echo "âœ… ëŒ€ì•ˆ í’ˆì§ˆ ê²€ì¦ í†µê³¼"
            else
              echo "âŒ ëŒ€ì•ˆ í’ˆì§ˆ ê²€ì¦ ì‹¤íŒ¨"
            fi
          else
            echo "ğŸ”„ ê¸°ë³¸ í´ë°± ê²€ì‚¬ ì‹¤í–‰ë¨"
          fi
          
          # ì „ì²´ ìƒíƒœ ê²°ì •
          if [[ "${{ steps.claude_review.outcome }}" == "success" ]] || \
             [[ "${{ steps.alternative_check.outputs.quality_passed }}" == "true" ]]; then
            echo "ğŸ‰ ì „ì²´ í’ˆì§ˆ ê²€ì¦: âœ… í†µê³¼"
            exit 0
          elif [[ "${{ steps.check_files.outputs.has_content }}" != "true" ]]; then
            echo "â„¹ï¸ ì „ì²´ í’ˆì§ˆ ê²€ì¦: ê²€ì¦ ëŒ€ìƒ ì—†ìŒ"
            exit 0
          else
            echo "âŒ ì „ì²´ í’ˆì§ˆ ê²€ì¦: ê¸°ì¤€ ë¯¸ë‹¬"
            exit 1
          fi

      - name: Quality Report Summary
        run: |
          echo "ğŸ“Š í’ˆì§ˆ ê²€ì¦ ì™„ë£Œ"
          echo "ğŸ¯ ë¡œë§¨ìŠ¤ íŒíƒ€ì§€ íŠ¹í™” ê²€ì¦ ì‹¤ì‹œ"
          echo "ğŸ“‹ í•©ê²© ê¸°ì¤€: 7.5/10 ì´ìƒ"
          echo "ğŸ“ˆ ê²€ì¦ í•­ëª©: ë¡œë§¨ìŠ¤ëª°ì…ë„/íŒíƒ€ì§€ì¼ê´€ì„±/ìºë¦­í„°ë§¤ë ¥ë„/ë¬¸ì¥ê°€ë…ì„±/ê¸°ëŒ€ê°"