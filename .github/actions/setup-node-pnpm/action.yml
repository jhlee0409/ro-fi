# ì¬ì‚¬ìš© ê°€ëŠ¥í•œ Node.js + pnpm í™˜ê²½ ì„¤ì • Composite Action
name: 'Setup Node.js with pnpm'
description: 'Node.js í™˜ê²½ê³¼ pnpmì„ ì„¤ì •í•˜ê³  ì„ íƒì ìœ¼ë¡œ ì˜ì¡´ì„±ì„ ì„¤ì¹˜í•©ë‹ˆë‹¤'
author: 'ro-fan automation team'

inputs:
  install-deps:
    description: 'ì˜ì¡´ì„± ì„¤ì¹˜ ì—¬ë¶€'
    required: false
    default: 'true'
  
  gemini-api-key:
    description: 'Gemini API í‚¤ (AI ì„œë¹„ìŠ¤ìš©)'
    required: false
    default: ''
  
  node-version:
    description: 'Node.js ë²„ì „'
    required: false
    default: '20'
  
  pnpm-version:
    description: 'pnpm ë²„ì „'
    required: false
    default: 'latest'

outputs:
  node-version:
    description: 'ì„¤ì¹˜ëœ Node.js ë²„ì „'
    value: ${{ steps.setup-node.outputs.node-version }}
  
  pnpm-version:
    description: 'ì„¤ì¹˜ëœ pnpm ë²„ì „'
    value: ${{ steps.setup-pnpm.outputs.version }}
  
  cache-hit:
    description: 'pnpm ìºì‹œ íˆíŠ¸ ì—¬ë¶€'
    value: ${{ steps.setup-node.outputs.cache-hit }}

runs:
  using: 'composite'
  steps:
    - name: ğŸ”§ pnpm ì„¤ì¹˜
      id: setup-pnpm
      uses: pnpm/action-setup@v4
      with:
        version: ${{ inputs.pnpm-version }}

    - name: ğŸ“¦ Node.js ì„¤ì •
      id: setup-node
      uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs.node-version }}
        cache: 'pnpm'

    - name: ğŸ“š ì˜ì¡´ì„± ì„¤ì¹˜
      if: inputs.install-deps == 'true'
      shell: bash
      run: |
        echo "ğŸ” pnpm ë²„ì „ í™•ì¸"
        pnpm --version

        echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
        pnpm install

        echo "ğŸ” ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€ í™•ì¸"
        ls -la node_modules/.bin/ | grep -E "(vitest|playwright)" || echo "í…ŒìŠ¤íŠ¸ ê´€ë ¨ ë°”ì´ë„ˆë¦¬ ì—†ìŒ"

        echo "ğŸ“‹ ì£¼ìš” íŒ¨í‚¤ì§€ í™•ì¸"
        pnpm list vitest || echo "vitest íŒ¨í‚¤ì§€ ì„¤ì¹˜ë˜ì§€ ì•ŠìŒ"
        pnpm list @playwright/test || echo "playwright íŒ¨í‚¤ì§€ ì„¤ì¹˜ë˜ì§€ ì•ŠìŒ"

        # PATHì— node_modules/.bin ì¶”ê°€
        echo "$PWD/node_modules/.bin" >> $GITHUB_PATH
        
        echo "âœ… ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"

    - name: ğŸ” í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
      if: inputs.gemini-api-key != ''
      shell: bash
      run: |
        echo "GEMINI_API_KEY=${{ inputs.gemini-api-key }}" >> $GITHUB_ENV
        echo "NODE_ENV=production" >> $GITHUB_ENV
        echo "âœ… AI ì„œë¹„ìŠ¤ í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ì™„ë£Œ"

    - name: âœ… ì„¤ì • ì™„ë£Œ ìš”ì•½
      shell: bash
      run: |
        echo "ğŸ“Š í™˜ê²½ ì„¤ì • ì™„ë£Œ"
        echo "==================="
        echo "ğŸ“¦ Node.js: $(node --version)"
        echo "ğŸ”§ pnpm: $(pnpm --version)"
        echo "ğŸ“š ì˜ì¡´ì„± ì„¤ì¹˜: ${{ inputs.install-deps }}"
        echo "ğŸ” AI API í‚¤: ${{ inputs.gemini-api-key != '' && 'ì„¤ì •ë¨' || 'ë¯¸ì„¤ì •' }}"
        echo "ğŸ¯ ì¤€ë¹„ ì™„ë£Œ!"

branding:
  icon: 'package'
  color: 'green'