---
import Layout from '../layouts/Layout.astro';
import LibraryHeroSection from '../components/sections/LibraryHeroSection.astro';
import FilterSection from '../components/sections/FilterSection.astro';
import NovelListSection from '../components/sections/NovelListSection.astro';
import AutomationInfoSection from '../components/sections/AutomationInfoSection.astro';
import { NovelDataService } from '../lib/data-services';
import '../styles/globals.css';

// ë°ì´í„° ì„œë¹„ìŠ¤ë¥¼ í†µí•´ í†µí•©ëœ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
const [novels, platformStats] = await Promise.all([
  NovelDataService.getAllNovels(),
  NovelDataService.getPlatformStats()
]);

// ê° ì†Œì„¤ë³„ í†µê³„ ê³„ì‚°
const novelStats = await NovelDataService.getNovelStats(novels);
---

<Layout 
  title="ë¡œë§¨ìŠ¤ íŒíƒ€ì§€ ì—°ì¬ ì†Œì„¤ | RO-FAN"
  description="AIê°€ ì°½ì¡°í•˜ëŠ” ë¬´í•œí•œ ë¡œë§¨ìŠ¤ íŒíƒ€ì§€ ì„¸ê³„ë¥¼ íƒí—˜í•˜ì„¸ìš”. ë§¤ì¼ ìƒˆë¡œìš´ ì´ì•¼ê¸°ë¥¼ ë§Œë‚˜ë³´ì„¸ìš”."
>
  <LibraryHeroSection 
    totalNovels={platformStats.totalNovels}
    activeNovels={platformStats.activeNovels}
    totalChapters={platformStats.totalChapters}
  />
  
  <FilterSection />
  
  <NovelListSection novels={novelStats} />
  
  <AutomationInfoSection />

  <!-- JavaScript for Filtering and Search -->
  <script>
    // DOM ìš”ì†Œë“¤
    const searchInput = document.getElementById('searchInput');
    const filterButtons = document.querySelectorAll('.filter-btn');
    const novelCards = document.querySelectorAll('.novel-card');

    // í˜„ì¬ í•„í„° ìƒíƒœ
    let currentFilter = 'all';
    let currentSearch = '';

    // ê²€ìƒ‰ ê¸°ëŠ¥
    searchInput?.addEventListener('input', (e) => {
      const target = e.target as HTMLInputElement;
      currentSearch = target.value.toLowerCase().trim();
      filterNovels();
    });

    // í•„í„° ë²„íŠ¼ ê¸°ëŠ¥
    filterButtons.forEach(button => {
      button.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;
        const filter = target.dataset.filter;
        if (!filter) return;

        // í™œì„± ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
        filterButtons.forEach(btn => {
          btn.classList.remove('active', 'bg-purple-600', 'text-white');
          btn.classList.add('bg-gray-100', 'text-gray-700');
        });

        target.classList.add('active', 'bg-purple-600', 'text-white');
        target.classList.remove('bg-gray-100', 'text-gray-700');

        currentFilter = filter;
        filterNovels();
      });
    });

    // ì†Œì„¤ í•„í„°ë§ í•¨ìˆ˜
    function filterNovels() {
      novelCards.forEach(card => {
        const cardElement = card as HTMLElement;
        const title = cardElement.dataset.title || '';
        const status = cardElement.dataset.status || '';

        let showCard = true;

        // ê²€ìƒ‰ í•„í„°
        if (currentSearch && !title.includes(currentSearch)) {
          showCard = false;
        }

        // ìƒíƒœ í•„í„°
        if (currentFilter !== 'all' && currentFilter !== 'latest') {
          if (status !== currentFilter) {
            showCard = false;
          }
        }

        // ì¹´ë“œ í‘œì‹œ/ìˆ¨ê¹€
        if (showCard) {
          cardElement.style.display = 'block';
          cardElement.classList.add('animate-fadeIn');
        } else {
          cardElement.style.display = 'none';
          cardElement.classList.remove('animate-fadeIn');
        }
      });

      // ìµœì‹ ìˆœ ì •ë ¬ - ì´ë¯¸ ì„œë²„ì—ì„œ ì •ë ¬ë˜ì–´ ìˆìœ¼ë¯€ë¡œ íŠ¹ë³„í•œ ì²˜ë¦¬ ë¶ˆí•„ìš”

      // ê²°ê³¼ê°€ ì—†ëŠ” ê²½ìš° ë©”ì‹œì§€ í‘œì‹œ
      const visibleCards = Array.from(novelCards).filter(card => {
        const el = card as HTMLElement;
        return el.style.display !== 'none';
      });
      const noResultsMessage = document.getElementById('no-results');

      if (visibleCards.length === 0 && !noResultsMessage) {
        const grid = document.getElementById('novels-grid');
        if (grid) {
          const message = document.createElement('div');
          message.id = 'no-results';
          message.className = 'col-span-full text-center py-16';
          message.innerHTML = `
            <div class="text-6xl mb-4">ğŸ”</div>
            <h3 class="text-xl font-semibold text-gray-900 mb-2">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
            <p class="text-gray-600">ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë‚˜ í•„í„°ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”</p>
          `;
          grid.appendChild(message);
        }
      } else if (visibleCards.length > 0 && noResultsMessage) {
        noResultsMessage.remove();
      }
    }

    // ì• ë‹ˆë©”ì´ì…˜ í´ë˜ìŠ¤ ì¶”ê°€
    const style = document.createElement('style');
    style.textContent = `
      .animate-fadeIn {
        animation: fadeIn 0.5s ease-in-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    `;
    document.head.appendChild(style);
  </script>
</Layout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>