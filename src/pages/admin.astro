---
import BaseLayout from '../layouts/BaseLayout.astro';
import AdminDashboard from '../components/AdminDashboard.astro';
import AdminLogin from '../components/AdminLogin.astro';
import { NovelDataService } from '../lib/data-services';
import '../styles/globals.css';

// í™˜ê²½ë³€ìˆ˜ ë˜ëŠ” ê¸°ë³¸ê°’ ì‚¬ìš© (ë³´ì•ˆ ê°•í™”)
const ADMIN_PASSWORD = import.meta.env.ADMIN_PASSWORD || 'zxc123';
const isDev = import.meta.env.DEV;

// íŒ¨ìŠ¤ì›Œë“œ ê²€ì¦ ë° ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const password = formData.get('password')?.toString()?.trim();
  const logout = formData.get('logout');

  if (logout) {
    // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ - ì™„ì „í•œ ì¿ í‚¤ ì‚­ì œ
    Astro.cookies.delete('admin_auth', {
      path: '/',
      domain: isDev ? undefined : Astro.url.hostname
    });
    return Astro.redirect('/', 302);
  }

  if (password) {
    if (password === ADMIN_PASSWORD) {
      // ì¸ì¦ ì„±ê³µ - ë³´ì•ˆ ê°•í™”ëœ ì¿ í‚¤ ì„¤ì •
      Astro.cookies.set('admin_auth', 'authenticated', {
        maxAge: 60 * 60 * 4, // 4ì‹œê°„
        httpOnly: true,
        secure: !isDev,
        sameSite: 'strict',
        path: '/'
      });

      return Astro.redirect('/admin', 302);
    } else {
      // íŒ¨ìŠ¤ì›Œë“œ í‹€ë¦¼ - ë¸Œë£¨íŠ¸í¬ìŠ¤ ë°©ì§€ë¥¼ ìœ„í•œ ë”œë ˆì´ í›„ í™ˆìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
      await new Promise(resolve => setTimeout(resolve, 1000));
      return Astro.redirect('/', 302);
    }
  }
}

// ì¸ì¦ ìƒíƒœ í™•ì¸
const authCookie = Astro.cookies.get('admin_auth');
const isAuthenticated = authCookie?.value === 'authenticated';

// ì¸ì¦ëœ ê²½ìš°ì—ë§Œ ë°ì´í„° ë¡œë”©
let novels: any[] = [];
let tropes: any[] = [];
let platformStats = { totalNovels: 0, totalChapters: 0, activeNovels: 0 };

if (isAuthenticated) {
  try {
    [novels, tropes, platformStats] = await Promise.all([
      NovelDataService.getAllNovels(),
      NovelDataService.getAllTropes(),
      NovelDataService.getPlatformStats()
    ]);
  } catch (error) {
    console.error('Failed to load collections:', error);
  }
}

// í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ë¡œê·¸ì¸ í•¸ë“¤ëŸ¬
const handleLogin = `
async function handleLogin(password) {
  const formData = new FormData();
  formData.append('password', password);

  const response = await fetch('/admin', {
    method: 'POST',
    body: formData
  });

  if (response.redirected) {
    window.location.href = response.url;
  }
}`;
---

<BaseLayout 
  title="ê´€ë¦¬ì í˜ì´ì§€ - AI ìŠ¤í† ë¦¬ ìƒì„±"
  description="RO-FAN AI ìŠ¤í† ë¦¬ ìƒì„± ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ"
>
  {!isAuthenticated ? (
    <AdminLogin 
      onLogin={handleLogin}
    />
  ) : (
    <AdminDashboard 
      novels={novels}
      tropes={tropes}
      platformStats={platformStats}
    />
  )}
</BaseLayout>
  
  <script>
import { coerce, record } from "astro:schema";


        const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        warning: 'bg-yellow-500',
        info: 'bg-blue-500'
      } as const

      type Color = keyof typeof colors;

    // AI ë„êµ¬ í¼ë“¤
    const plotForm = document.getElementById('plotForm');
    const chapterForm = document.getElementById('chapterForm');
    const improveForm = document.getElementById('improveForm');

    // í¼ ì œì¶œ í•¸ë“¤ëŸ¬ë“¤
    plotForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      if(!e.target) return;
      const target = e.target as HTMLFormElement;
      const formData = new FormData(target);
      const title = formData.get('title');
      const tropes = formData.getAll('tropes');

      if (tropes.length === 0) {
        showNotification('ìµœì†Œ 1ê°œì˜ íŠ¸ë Œë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
        return;
      }

      await generateContent('generate-plot', { title, tropes }, 'plotResult', target);
    });

    chapterForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      if(!e.target) return;
      const target = e.target as HTMLFormElement;
      const formData = new FormData(target);
      const chapterNumber = formData.get('chapterNumber')

      const data = {
        title: formData.get('novel'),
        chapterNumber,
        previousContext: formData.get('previousContext'),
        tropes: []
      };

      await generateContent('generate-chapter', data, 'chapterResult', target);
    });

    improveForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      if(!e.target) return;
      const target = e.target as HTMLFormElement;
      const formData = new FormData(target);
      const originalChapter = formData.get('originalChapter');
      const improvementCriteria = formData.getAll('criteria');

      if (improvementCriteria.length === 0) {
        showNotification('ìµœì†Œ 1ê°œì˜ ê°œì„  ê¸°ì¤€ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
        return;
      }

      await generateContent('improve-chapter', { originalChapter, improvementCriteria }, 'improveResult', target);
    });

    // AI ì½˜í…ì¸  ìƒì„± í•¨ìˆ˜
    async function generateContent(action: string, data: any, resultElementId: string, formElement: HTMLFormElement) {
      const resultElement = document.getElementById(resultElementId);
      const submitButton = formElement.querySelector('button[type="submit"]') as HTMLButtonElement

      if (!resultElement || !submitButton) return;

      // ë¡œë”© ìƒíƒœ ì‹œì‘
      const originalText = submitButton.innerHTML;
      submitButton.innerHTML = '<span class="animate-spin">â³</span> AI ì°½ì‘ ì¤‘...';
      submitButton.disabled = true;

      resultElement.innerHTML = `
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
          <div class="animate-spin text-2xl mb-2">ğŸ¤–</div>
          <div class="text-sm text-blue-700">AIê°€ ì—´ì‹¬íˆ ì°½ì‘ ì¤‘ì…ë‹ˆë‹¤...</div>
        </div>
      `;

      try {
        const response = await fetch('/api/generate-story', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action, ...data })
        });

        const result = await response.json();

        if (result.success) {
          resultElement.innerHTML = `
            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
              <div class="flex justify-between items-center mb-3">
                <h4 class="text-green-800 font-medium">âœ… ìƒì„± ì™„ë£Œ!</h4>
                <button onclick="copyToClipboard(this)" class="text-sm bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">
                  ğŸ“‹ ë³µì‚¬í•˜ê¸°
                </button>
              </div>
              <div class="bg-white rounded border p-3 max-h-64 overflow-y-auto">
                <pre class="text-sm whitespace-pre-wrap">${typeof result.data === 'object' ? JSON.stringify(result.data, null, 2) : result.data}</pre>
              </div>
            </div>
          `;
          showNotification('ì½˜í…ì¸ ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        } else {
          resultElement.innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
              <h4 class="text-red-800 font-medium mb-2">âŒ ìƒì„± ì‹¤íŒ¨</h4>
              <p class="text-red-700 text-sm">${result.error}</p>
              ${result.details ? `<p class="text-red-600 text-xs mt-1">${result.details}</p>` : ''}
            </div>
          `;
          showNotification('ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
        }
      } catch (error) {
        resultElement.innerHTML = `
          <div class="bg-red-50 border border-red-200 rounded-lg p-4">
            <h4 class="text-red-800 font-medium mb-2">âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜</h4>
            <p class="text-red-700 text-sm">ì„œë²„ì™€ì˜ í†µì‹ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
          </div>
        `;
        showNotification('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      } finally {
        // ë¡œë”© ìƒíƒœ ì¢…ë£Œ
        submitButton.innerHTML = originalText;
        submitButton.disabled = false;
      }
    }





    // ì•Œë¦¼ ì‹œìŠ¤í…œ
    function showNotification(message: string, type = 'info' as Color) {

      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full`;
      notification.innerHTML = `
        <div class="flex items-center justify-between">
          <span>${message}</span>
          <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">Ã—</button>
        </div>
      `;

      document.body.appendChild(notification);

      // ì• ë‹ˆë©”ì´ì…˜
      setTimeout(() => {
        notification.classList.remove('translate-x-full');
      }, 100);

      // ìë™ ì œê±°
      setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => notification.remove(), 300);
      }, 5000);
    }

    // í´ë¦½ë³´ë“œ ë³µì‚¬
    function copyToClipboard(button : HTMLButtonElement) {
      if(!button) return;
      const content = button.closest('.bg-green-50')?.querySelector('pre')?.textContent;
      if(!content)return;
      if (navigator.clipboard) {
        navigator.clipboard.writeText(content).then(() => {
          button.textContent = 'âœ… ë³µì‚¬ë¨!';
          setTimeout(() => {
            button.textContent = 'ğŸ“‹ ë³µì‚¬í•˜ê¸°';
          }, 2000);
        });
      }
    }
  </script>
</Layout>